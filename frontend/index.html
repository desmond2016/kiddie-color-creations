<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiddie Color Creations - 儿童涂色创作平台</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="site-header">
        <div class="container header-container">
            <div class="logo">
                Kiddie Color Creations <span class="logo-subtitle">儿童涂色乐园</span>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#">首页</a></li>
                    <li><a href="admin.html">管理员</a></li>
                </ul>

                <!-- 未登录状态 -->
                <div id="auth-buttons" class="auth-panel">
                    <button id="auth-login-btn" class="auth-btn">登录</button>
                    <button id="auth-register-btn" class="auth-btn register">注册</button>
                </div>

                <!-- 已登录状态 -->
                <div id="user-panel" class="user-panel" style="display: none;">
                    <div class="credits-display">
                        <i class="fas fa-coins"></i>
                        <span id="credits-count">0</span> 积分
                    </div>
                    <div class="user-menu">
                        <button id="user-menu-toggle" class="user-menu-toggle">
                            <i class="fas fa-user"></i>
                            <span id="username-display">用户名</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="user-dropdown" class="user-dropdown">
                            <a href="#" id="redeem-code-btn"><i class="fas fa-gift"></i> 兑换积分</a>
                            <a href="#" id="transaction-history-btn"><i class="fas fa-history"></i> 使用记录</a>
                            <a href="#" id="change-password-btn"><i class="fas fa-key"></i> 修改密码</a>
                            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
                        </div>
                    </div>
                </div>

                <button class="theme-toggle" aria-label="切换主题">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </nav>
        </div>
    </header>

    <!-- 认证模态框 -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="auth-modal-title">��户登录</h2>
                <span class="close" id="close-auth-modal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 登录表单 -->
                <form id="login-form" class="auth-form">
                    <div class="form-group">
                        <label for="login-username">用户名或邮箱</label>
                        <input type="text" id="login-username" name="login" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">密码</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">登录</button>
                    <p class="auth-switch">
                        还没有账号？<a href="#" id="switch-to-register">立即注册</a>
                    </p>
                </form>

                <!-- 注册表单 -->
                <form id="register-form" class="auth-form" style="display: none;">
                    <div class="form-group">
                        <label for="register-username">用户名</label>
                        <input type="text" id="register-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">邮箱</label>
                        <input type="email" id="register-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">密码</label>
                        <input type="password" id="register-password" name="password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">注册</button>
                    <p class="auth-switch">
                        已有账号？<a href="#" id="switch-to-login">立即登录</a>
                    </p>
                </form>

                <div id="auth-message" class="message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- 兑换积分模态框 -->
    <div id="redeem-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>兑换积分</h2>
                <span class="close" id="close-redeem-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="redeem-form">
                    <div class="form-group">
                        <label for="redeem-code-input">兑换码</label>
                        <input type="text" id="redeem-code-input" name="code" required
                               placeholder="请输入16位兑换码" maxlength="16" style="text-transform: uppercase;">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">兑换</button>
                </form>
                <div id="redeem-message" class="message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- 交易记录模态框 -->
    <div id="history-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>积分使用记录</h2>
                <span class="close" id="close-history-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="transaction-list" class="transaction-list">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>修改密码</h2>
                <span class="close" id="close-change-password-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">当前密码</label>
                        <input type="password" id="current-password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">新密码</label>
                        <input type="password" id="new-password" name="new_password" required
                               minlength="6" title="密码长度至少6位">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">确认新密码</label>
                        <input type="password" id="confirm-new-password" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">修改密码</button>
                </form>
                <div id="change-password-message" class="message" style="display: none;"></div>
            </div>
        </div>
    </div>







    <main>
        <section class="hero-section">
            <div class="container">
                <h1>发现魔法森林的色彩</h1>
                <p>踏上一场奇妙的探索之旅，用你的想象力为神秘的独角兽世界添加绚丽色彩。让创意在指尖绽放！</p>
                <a href="#coloring-section" class="scroll-down-arrow" aria-label="滚动到涂色区域">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </a>
            </div>
        </section>

        <section class="coloring-page" id="coloring-section">
            <div class="container">
                <h2>发挥你的想象力！</h2>
                <p class="section-subtitle">输入你想要画的场景，让魔法为你生成专属涂色线条画</p>

                <div class="image-container">
                    <div id="placeholder-content" class="placeholder-content">
                        <i class="fas fa-image"></i>
                        <p>您生成的涂色图片将显示在这里</p>
                    </div>
                    <img id="main-coloring-image" alt="涂色线条画" style="display: none;">
                    <div class="loading-overlay" id="loading-indicator" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在生成线条画...</p>
                    </div>
                </div>

                <div class="info-box description generation-controls">
                    <p><strong>图片描述：</strong></p>
                    <input type="text" id="prompt-input" placeholder="例如：一只戴着帽子的可爱小猫">

                    <!-- 积分消费提示 -->
                    <div id="credits-info" class="credits-info">
                        <i class="fas fa-coins"></i>
                        <span>生成1张图片+1套配色方案需要 2 积分</span>
                    </div>

                    <!-- 登录提示 -->
                    <div id="login-prompt" class="login-prompt">
                        <i class="fas fa-lock"></i>
                        <span>请先登录后使用生成功能</span>
                        <button id="prompt-login-btn" class="auth-btn">立即登录</button>
                    </div>

                    <button id="generate-button">
                        <i class="fas fa-magic"></i> 生成线条画
                    </button>
                    <p id="error-message" class="error-text" style="display: none;"></p>
                </div>

                <button class="download-button" id="download-link" style="display: none;" onclick="downloadCurrentImage()">
                    下载图片
                </button>

                <div class="info-box printing-tip">
                    <p><strong>打印提示：</strong> 为获得最佳效果，请在打印机设置中选择"无边距打印"或"满幅面打印"！</p>
                </div>
            </div>
        </section>

        <section class="color-palette-section">
            <div class="container">
                <h2>推荐配色方案</h2>
                <p class="section-subtitle">点击下方颜色块，获取灵感</p>

                <div class="palette-loading" id="palette-loading-indicator" style="display: none;">
                    <i class="fas fa-palette fa-spin"></i>
                    <span>正在生成智能配色...</span>
                </div>

                <div id="color-swatches-container" class="color-swatches">
                    <span class="swatch" style="background-color: #FFC0CB;" title="粉色"></span>
                    <span class="swatch" style="background-color: #DA70D6;" title="紫色"></span>
                    <span class="swatch" style="background-color: #87CEEB;" title="蓝色"></span>
                    <span class="swatch" style="background-color: #AFEEEE;" title="青色"></span>
                    <span class="swatch" style="background-color: #90EE90;" title="绿色"></span>
                    <span class="swatch" style="background-color: #FFFFE0;" title="黄色"></span>
                    <span class="swatch" style="background-color: #FFA07A;" title="橙色"></span>
                    <span class="swatch" style="background-color: #F08080;" title="红色"></span>
                </div>
                <p class="palette-tip">
                    <strong>贴心提示：</strong>发挥你的创意，为生成的线条画涂上独一无二的色彩吧！
                </p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; <span id="current-year">2025</span> Kiddie Color Creations. 版权所有。</p>
        </div>
    </footer>

    <div id="message-container"></div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // 设置当前年份
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，初始化认证系统');
            
            // 初始化认证系统
            initAuth();

            // 绑定认证相关事件
            bindAuthEvents();

            // 恢复页面状态
            loadCurrentState();

            // 监听页面可见性变化，防止状态丢失
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // 页面重新可见时，检查并恢复状态
                    console.log('页面重新可见，检查状态...');
                    setTimeout(() => {
                        // 检查认证状态
                        if (localStorage.getItem('authToken') && !authSystem.getAuthToken()) {
                            console.log('检测到认证状态异常，正在恢复...');
                            authSystem.updateUI();
                        }

                        // 检查页面状态
                        if (currentImageData.url && (!mainImage.src || mainImage.style.display === 'none')) {
                            console.log('检测到页面状态异常，正在恢复...');
                            restoreUIState();
                        }
                    }, 100);
                }
            });
        });

        function bindAuthEvents() {
            // 登录按钮
            const authLoginBtn = document.getElementById('auth-login-btn');
            if (authLoginBtn) {
                authLoginBtn.addEventListener('click', () => {
                    authSystem.openModal('auth-modal');
                    switchToLogin();
                });
            }

            // 注册按钮
            const authRegisterBtn = document.getElementById('auth-register-btn');
            if (authRegisterBtn) {
                authRegisterBtn.addEventListener('click', () => {
                    authSystem.openModal('auth-modal');
                    switchToRegister();
                });
            }

            // 登录提示按钮
            const promptLoginBtn = document.getElementById('prompt-login-btn');
            if (promptLoginBtn) {
                promptLoginBtn.addEventListener('click', () => {
                    authSystem.openModal('auth-modal');
                    switchToLogin();
                });
            }

            // 用户菜单切换
            const userMenuToggle = document.getElementById('user-menu-toggle');
            if (userMenuToggle) {
                userMenuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = document.getElementById('user-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
            }

            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', () => {
                authSystem.closeUserDropdown();
            });

            // 模态框关闭按钮
            const closeAuthModal = document.getElementById('close-auth-modal');
            if (closeAuthModal) {
                closeAuthModal.addEventListener('click', () => {
                    authSystem.closeModal('auth-modal');
                });
            }

            const closeRedeemModal = document.getElementById('close-redeem-modal');
            if (closeRedeemModal) {
                closeRedeemModal.addEventListener('click', () => {
                    authSystem.closeModal('redeem-modal');
                });
            }

            const closeHistoryModal = document.getElementById('close-history-modal');
            if (closeHistoryModal) {
                closeHistoryModal.addEventListener('click', () => {
                    authSystem.closeModal('history-modal');
                });
            }

            const closeChangePasswordModal = document.getElementById('close-change-password-modal');
            if (closeChangePasswordModal) {
                closeChangePasswordModal.addEventListener('click', () => {
                    authSystem.closeModal('change-password-modal');
                });
            }

            // 用户下拉菜单项
            const redeemCodeBtn = document.getElementById('redeem-code-btn');
            if (redeemCodeBtn) {
                redeemCodeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    authSystem.closeUserDropdown();
                    authSystem.openModal('redeem-modal');
                });
            }

            const transactionHistoryBtn = document.getElementById('transaction-history-btn');
            if (transactionHistoryBtn) {
                transactionHistoryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    authSystem.closeUserDropdown();
                    authSystem.openModal('history-modal');
                    authSystem.loadTransactionHistory();
                });
            }

            const changePasswordBtn = document.getElementById('change-password-btn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    authSystem.closeUserDropdown();
                    authSystem.openModal('change-password-modal');
                });
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    authSystem.logout();
                });
            }

            // 表单切换
            const switchToRegisterBtn = document.getElementById('switch-to-register');
            if (switchToRegisterBtn) {
                switchToRegisterBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchToRegister();
                });
            }

            const switchToLoginBtn = document.getElementById('switch-to-login');
            if (switchToLoginBtn) {
                switchToLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchToLogin();
                });
            }

            // 表单提交
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    await authSystem.login(formData.get('login'), formData.get('password'));
                });
            }

            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    await authSystem.register(
                        formData.get('username'),
                        formData.get('email'),
                        formData.get('password')
                    );
                });
            }

            // 兑换码表单提交
            const redeemForm = document.getElementById('redeem-form');
            if (redeemForm) {
                redeemForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const code = formData.get('code').trim().toUpperCase();

                    if (code.length !== 16) {
                        showMessage('redeem-message', '兑换码必须是16位', 'error');
                        return;
                    }

                    await authSystem.redeemCode(code);
                });
            }

            // 修改密码表单提交
            const changePasswordForm = document.getElementById('change-password-form');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const currentPassword = formData.get('current_password');
                    const newPassword = formData.get('new_password');
                    const confirmPassword = formData.get('confirm_password');

                    if (newPassword !== confirmPassword) {
                        showMessage('change-password-message', '两次输入的新密码不一致', 'error');
                        return;
                    }

                    await authSystem.changePassword(currentPassword, newPassword, confirmPassword);
                });
            }
        }

        // 获取需要的 DOM 元素
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const mainImage = document.getElementById('main-coloring-image');
        const placeholderContent = document.getElementById('placeholder-content');
        const loadingIndicator = document.getElementById('loading-indicator');
        const downloadLink = document.getElementById('download-link');
        const errorMessage = document.getElementById('error-message');
        const colorSwatchesContainer = document.getElementById('color-swatches-container');
        const paletteLoadingIndicator = document.getElementById('palette-loading-indicator');

        // 状态管理变量
        let currentImageData = {
            url: null,
            prompt: null,
            filename: null
        };
        let currentColorPalette = [];

        // 状态持久化函数
        function saveCurrentState() {
            localStorage.setItem('currentImageData', JSON.stringify(currentImageData));
            localStorage.setItem('currentColorPalette', JSON.stringify(currentColorPalette));
            console.log('状态已保存到localStorage');
        }

        function loadCurrentState() {
            try {
                const savedImageData = localStorage.getItem('currentImageData');
                const savedColorPalette = localStorage.getItem('currentColorPalette');

                if (savedImageData) {
                    currentImageData = JSON.parse(savedImageData);
                    console.log('恢��图片状态:', currentImageData);
                }

                if (savedColorPalette) {
                    currentColorPalette = JSON.parse(savedColorPalette);
                    console.log('恢复配色状态:', currentColorPalette);
                }

                // 恢复UI状态
                restoreUIState();
            } catch (error) {
                console.error('恢复状态失败:', error);
            }
        }

        function restoreUIState() {
            // 恢复图片显示
            if (currentImageData.url) {
                mainImage.src = currentImageData.url;
                mainImage.alt = `线条画: ${currentImageData.prompt}`;
                mainImage.style.display = 'block';
                placeholderContent.style.display = 'none';
                downloadLink.style.display = 'block';
                console.log('恢复图片显示');
            }

            // 恢复配色方案显示
            if (currentColorPalette.length > 0) {
                colorSwatchesContainer.innerHTML = '';
                currentColorPalette.forEach(color => {
                    const colorSwatch = document.createElement('span');
                    colorSwatch.className = 'swatch';
                    colorSwatch.style.backgroundColor = color;
                    colorSwatch.title = `点击复制颜色: ${color}`;
                    colorSwatch.setAttribute('data-color', color);
                    colorSwatch.addEventListener('click', () => {
                        copyColorToClipboard(color, colorSwatch);
                    });
                    colorSwatchesContainer.appendChild(colorSwatch);
                });
                console.log('恢复配色方案显示');
            }
        }

        // 复制颜色到剪贴板
        function copyColorToClipboard(color, element) {
            navigator.clipboard.writeText(color).then(() => {
                // 显示复制成功的视觉反馈
                const originalTitle = element.title;
                element.title = '已复制!';
                element.style.transform = 'scale(1.1)';

                setTimeout(() => {
                    element.title = originalTitle;
                    element.style.transform = 'scale(1)';
                }, 1000);

                console.log('颜色已复制到剪贴板:', color);
            }).catch(err => {
                console.error('复制失败:', err);
                // 降级方案：显示颜色值
                alert(`颜色代码: ${color}`);
            });
        }

        // 切换登录/注册表单
        function switchToLogin() {
            document.getElementById('auth-modal-title').textContent = '用户登录';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            hideMessage('auth-message');
        }

        function switchToRegister() {
            document.getElementById('auth-modal-title').textContent = '用户注册';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            hideMessage('auth-message');
        }

        // 修改原有的生成图片函数，添加认证检查
        const originalGenerateButton = document.getElementById('generate-button');
        if (originalGenerateButton) {
            originalGenerateButton.addEventListener('click', async () => {
                // 检查登录状态
                if (!authSystem.getCurrentUser() || !authSystem.getAuthToken()) {
                    showMessage('error-message', '请先登录后再使用生成功能', 'error');
                    authSystem.openModal('auth-modal');
                    switchToLogin();
                    return;
                }

                // 检查积分余额（需要2积分：1积分生成图片 + 1积分生成配色）
                const user = authSystem.getCurrentUser();
                if (user.credits < 2) {
                    showMessage('error-message', `积分余额不足，需要2积分，当前余额${user.credits}积分。请先兑换积分！`, 'error');
                    return;
                }

                // 调用原有的生成逻辑（需要修改为使用认证）
                await generateImageWithAuth();
            });
        }

        // 带认证的图片生成函数 - 使用统一的创作生成API
        async function generateImageWithAuth() {
            const prompt = document.getElementById('prompt-input').value.trim();

            // 改进的输入验证
            if (!prompt) {
                showMessage('error-message', '请输入图片描述！', 'error');
                document.getElementById('prompt-input').focus();
                return;
            }

            if (prompt.length < 2) {
                showMessage('error-message', '图片描述太短，请至少输入2个字符', 'error');
                document.getElementById('prompt-input').focus();
                return;
            }

            if (prompt.length > 200) {
                showMessage('error-message', '图片描述太长，请限制在200字符以内', 'error');
                document.getElementById('prompt-input').focus();
                return;
            }

            const loadingIndicator = document.getElementById('loading-indicator');
            const placeholderContent = document.getElementById('placeholder-content');
            const mainImage = document.getElementById('main-coloring-image');
            const generateButton = document.getElementById('generate-button');
            const errorMessage = document.getElementById('error-message');
            const paletteLoadingIndicator = document.getElementById('palette-loading-indicator');

            // 显示加载状态
            loadingIndicator.style.display = 'flex';
            placeholderContent.style.display = 'none';
            mainImage.style.opacity = '0.5';
            mainImage.style.display = 'none'; // 隐藏旧图片
            generateButton.disabled = true;
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            paletteLoadingIndicator.style.display = 'block';
            hideMessage('error-message');

            try {
                console.log('开始生成创作，prompt:', prompt);
                console.log('使用token:', authSystem.getAuthToken());

                // 使用统一的创作生成API
                const response = await fetch(CONFIG.API_BASE_URL + '/credits/generate-creation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authSystem.getAuthToken()}`
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                console.log('生成创作响应状态:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '无法解析错误信息' }));
                    console.error('生成创作失败，错误数据:', errorData);
                    
                    // 根据错误类型提供更具体的提示
                    let errorMessage = errorData.error || `服务器错误: ${response.status}`;
                    if (response.status === 400 && errorData.current_credits !== undefined) {
                        errorMessage = `${errorData.error}。请点击右上角"兑换积分"获取更多积分。`;
                    } else if (response.status === 401) {
                        errorMessage = '登录已过期，请重新登录';
                    } else if (response.status === 503) {
                        errorMessage = '服务暂时不可用，请稍后重试';
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('生成创作成功，响应数据:', data);

                if (data && data.imageUrl && data.colors) {
                    // 更新图片显示
                    currentImageData = {
                        url: data.imageUrl,
                        prompt: prompt,
                        filename: `ColoringPage_${prompt.replace(/[^a-z0-9]/gi, '_').substring(0, 20)}.png`
                    };

                    mainImage.src = data.imageUrl;
                    mainImage.alt = `线条画: ${prompt}`;
                    
                    // 添加图片加载错误处理
                    mainImage.onload = function() {
                        console.log('图片加载成功');
                        mainImage.style.display = 'block';
                        placeholderContent.style.display = 'none';
                        downloadLink.style.display = 'block';
                    };
                    
                    mainImage.onerror = function() {
                        console.error('图片加载失败:', data.imageUrl);
                        // 图片加载失败时显示错误信息
                        showMessage('error-message', '图片加载失败，请稍后重试', 'error');
                        placeholderContent.style.display = 'flex';
                        mainImage.style.display = 'none';
                        downloadLink.style.display = 'none';
                    };
                    
                    // 如果是SVG占位符，直接显示
                    if (data.imageUrl.startsWith('data:image/svg+xml')) {
                        mainImage.style.display = 'block';
                        placeholderContent.style.display = 'none';
                        downloadLink.style.display = 'block';
                        
                        // 如果有服务器消息，显示给用户
                        if (data.message) {
                            showMessage('error-message', data.message, 'warning');
                        }
                    }

                    // 更新配色方案
                    currentColorPalette = data.colors;
                    updateColorSwatches(data.colors);

                    // 更新用户积分信息
                    if (data.user) {
                        authSystem.updateUserInfo(data.user);
                    }

                    // 保存状态
                    saveCurrentState();

                    console.log('创作生成完成，积分已扣减');
                } else {
                    throw new Error('后端未返回有效的创作数据');
                }

            } catch (error) {
                console.error('调用后端 API 时出错:', error);

                // 特殊处理401错误（认证失败）
                if (error.message.includes('401') || error.message.includes('无效的登录令牌')) {
                    console.log('认证失败，尝试重新获取用户信息...');
                    try {
                        await authSystem.refreshUserInfo();
                        showMessage('error-message', '登录状态已更新，请重试生成', 'warning');
                    } catch (refreshError) {
                        showMessage('error-message', '登录已过期，请重新登录', 'error');
                        authSystem.openModal('auth-modal');
                    }
                } else if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    showMessage('error-message', '无法连接到后端服务，请确保后端正在运行且地址正确。', 'error');
                } else {
                    showMessage('error-message', `生成失败: ${error.message}`, 'error');
                }
                
                placeholderContent.style.display = 'flex';
                mainImage.style.display = 'none';
                } finally {
                    loadingIndicator.style.display = 'none';
                    paletteLoadingIndicator.style.display = 'none';
                    mainImage.style.opacity = '1';
                    generateButton.disabled = false;
                    generateButton.innerHTML = '<i class="fas fa-magic"></i> 生成线条画';
                }
        }

        // 更新配色方案显示
        function updateColorSwatches(colors) {
            const colorSwatchesContainer = document.getElementById('color-swatches-container');
            colorSwatchesContainer.innerHTML = '';

            if (colors && Array.isArray(colors)) {
                colors.forEach(color => {
                    if (typeof color === 'string' && /^#[0-9A-F]{6}$/i.test(color)) {
                        const swatch = document.createElement('span');
                        swatch.className = 'swatch';
                        swatch.style.backgroundColor = color;
                        swatch.title = `点击复制: ${color}`;
                        swatch.setAttribute('data-color', color);
                        swatch.addEventListener('click', () => copyColorToClipboard(color, swatch));
                        colorSwatchesContainer.appendChild(swatch);
                    }
                });
            }
        }

        // 更新配色方案的函数
        async function updateColorPalette(imageUrl) {
            const colorSwatchesContainer = document.getElementById('color-swatches-container');
            const paletteLoadingIndicator = document.getElementById('palette-loading-indicator');
            const paletteSection = document.querySelector('.color-palette-section');

            colorSwatchesContainer.innerHTML = ''; // 清空现有颜色块
            paletteLoadingIndicator.style.display = 'block'; // 显示加载指示器
            if (paletteSection) {
                paletteSection.style.display = 'block'; // 显示配色区域
            }

            try {
                // 调用后端配色API
                const backendUrl = CONFIG.API_BASE_URL + '/credits/generate-colors';
                console.log(`正在向后端发送配色请求: ${backendUrl}`);
                console.log('配色请求使用token:', authSystem.getAuthToken() ? authSystem.getAuthToken().substring(0, 20) + '...' : 'null');
                console.log('配色请求使用imageUrl:', imageUrl);

                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authSystem.getAuthToken()}`
                    },
                    body: JSON.stringify({ imageUrl: imageUrl })
                });

                console.log('配色API响应状态:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '无法解析错误信息' }));
                    console.error('配色生成失败，错误数据:', errorData);
                    throw new Error(errorData.error || `配色服务器错误: ${response.status}`);
                }

                const data = await response.json();
                console.log('从后端获取到的配色数据:', data);

                if (data && data.colors && Array.isArray(data.colors)) {
                    // 更新配色状态
                    currentColorPalette = data.colors;

                    // 清空现有颜色块
                    colorSwatchesContainer.innerHTML = '';

                    data.colors.forEach(color => {
                        if (typeof color === 'string' && /^#[0-9A-F]{6}$/i.test(color)) {
                            const swatch = document.createElement('span');
                            swatch.className = 'swatch';
                            swatch.style.backgroundColor = color;
                            swatch.title = `点击复制: ${color}`;
                            swatch.setAttribute('data-color', color);
                            swatch.addEventListener('click', () => copyColorToClipboard(color, swatch));
                            colorSwatchesContainer.appendChild(swatch);
                        } else {
                            console.warn(`收到的无效颜色代码: ${color}`);
                        }
                    });

                    console.log('配色生成成功，准备刷新用户积分');

                    // 保存配色状态
                    saveCurrentState();
                } else {
                    console.error('后端未返回有效的颜色数组');
                    displayDefaultColors('未能获取有效配色数组');
                }

            } catch (error) {
                console.error('调用配色API时发生错误:', error);
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    displayDefaultColors('无法连���到配色服务，使用默认配色');
                } else {
                    displayDefaultColors(`配色生成失败: ${error.message}`);
                }

                // 即使配色失败，也要刷新积分（因为图片生成可能成功了）
                console.log('配色生成失败，但仍需刷新用户积分');
                try {
                    await authSystem.refreshUserInfo();
                } catch (refreshError) {
                    console.error('刷新用户积分失败:', refreshError);
                }
            } finally {
                paletteLoadingIndicator.style.display = 'none';
            }
        }

        // 显示默认颜色块（在API调用失败或初始加载时）
        function displayDefaultColors(message) {
            const colorSwatchesContainer = document.getElementById('color-swatches-container');
            const defaultColors = ["#FFC0CB", "#DA70D6", "#87CEEB", "#AFEEEE", "#90EE90", "#FFFFE0", "#FFA07A", "#F08080"];

            // 更新配色状态
            currentColorPalette = defaultColors;

            colorSwatchesContainer.innerHTML = '';
            defaultColors.forEach(color => {
                const swatch = document.createElement('span');
                swatch.className = 'swatch';
                swatch.style.backgroundColor = color;
                swatch.title = color;
                swatch.setAttribute('data-color', color);
                swatch.addEventListener('click', () => copyColorToClipboard(color, swatch));
                colorSwatchesContainer.appendChild(swatch);
            });

            // 保存配色状态
            saveCurrentState();

            console.log('显示默认配色:', message);
        }

        // 下载当前图片函数
        async function downloadCurrentImage() {
            if (!currentImageData.url) {
                console.error('没有可下载的图片');
                return;
            }

            console.log('开始下载图片:', currentImageData.url);

            // 保存当前认证状态，防止下载操作影响登录
            const currentAuthToken = authSystem.getAuthToken();
            const currentUserData = authSystem.getCurrentUser();

            try {
                // 使用fetch获取图片数据，避免直接导航
                const response = await fetch(currentImageData.url);
                const blob = await response.blob();

                // 创建Blob URL
                const blobUrl = URL.createObjectURL(blob);

                // 创建临时下载链接
                const tempLink = document.createElement('a');
                tempLink.href = blobUrl;
                tempLink.download = currentImageData.filename || 'ColoringPage.png';
                tempLink.style.display = 'none';

                // 添加到DOM，触发下载，然后清理
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);

                // 清理Blob URL
                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                }, 1000);

                console.log('图片下载完成');
            } catch (error) {
                console.error('下载失败，使用备用方法:', error);

                // 备用方法：直接使用原URL
                const tempLink = document.createElement('a');
                tempLink.href = currentImageData.url;
                tempLink.download = currentImageData.filename || 'ColoringPage.png';
                tempLink.target = '_blank';  // 在新窗口打开，避免影响当前页面
                tempLink.style.display = 'none';

                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);

                console.log('使用备用方法下载完成');
            }

            // 下载完成后，确���认证状态和页面状态保持不变
            setTimeout(() => {
                // 检查认证状态是否被意外清除
                if (!authSystem.getAuthToken() && currentAuthToken) {
                    console.log('检测到认证状态丢失，正在恢复...');
                    // 恢复认证状态
                    localStorage.setItem('authToken', currentAuthToken);
                    if (currentUserData) {
                        localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                    }
                    // 重新初始化认证系统
                    authSystem.updateUI();
                }

                // 确保页面状态正确显示
                if (currentImageData.url && !mainImage.src) {
                    console.log('检测到图片状态丢失，正在恢复...');
                    restoreUIState();
                }

                console.log('下载后状态检查完成');
            }, 500);
        }
    </script>
</body>
</html>